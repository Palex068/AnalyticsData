#  Алгоритмы математических и статистических функций для расчета

# Содержание

+ [Введение](#введение)
+ [Связи](#связи)
+ [Кратность и кроссфильтрация](#кратность-и-кроссфильтрация)
    + [Основные характеристики связей](#основные-характеристики-связей)
        + [Кратность](#кратность)
        + [Многие ко многим](#многие-ко-многим)
    + [Кроссфильтрация](#кроссфильтрация)
        + [Однонаправленная](#однонаправленная)
        + [Двунаправленная](#двунаправленная)
    + [Однонаправленная кроссфильтрация](#однонаправленная-кроссфильтрация)
    + [Двунаправленная кроссфильтрация](#двунаправленная-кроссфильтрация)
+ [DAX - Data analysis expressions](#dax---data-analysis-expressions)
    + [Что такое DAX?](#что-такое-dax)
    + [Что такое меры?](#что-такое-меры)
    + [Синтаксис DAX](#синтаксис-dax)
    + [Функции DAX](#функции-dax)
        + [Категории функций](#категории-функций-dax)
        + [Операторы DAX](#операторы-dax)
+ [Быстрые меры](#быстрые-меры)


[Содержание курса](/GBPowerBI/README.md)

# Введение

Всем привет. Рад приветствовать на шестом занятии нашего водного курса по бизнесу.
Сегодня мы будем с вами разбирать аналитические функции связи, алгоритмы и так далее. 

Основное, на чем мы сделаем упор это язык Dax, но Dax зачастую ассоциируется только с функциями. Но сегодня мы многое внимания уделим функционалу связи, потому что
+ во-первых, нужно понимать что это один из важных функционалов. 
+ Во-вторых, он также написан Dax Просто его можно сделать из коробки.

На этой лекции вы познакомитесь с методами создания связей в разных таблицах с целью объединять данные по общему признаку в столбцах. 

В рамках работы в Power BI настройка связей позволяет пользователю не тратить время на сведение данных в одну таблицу, то есть осуществлять набор данных. И также вы познакомитесь с базовым функционалом DAX: синтаксис, популярные формулы, быстрые меры.

<hr>

[Содержание](#содержание)

# Связи

![006](/GBPowerBI/Pictures/006_017.png)

Связи позволяют объединять таблицы по общему признаку. Настраиваются для конкретного столбца в каждой из связанных таблиц.

Пример: перед вами задача — построить простой прогноз продаж на будущий год по текущим клиентам. У вас есть данные о фактических продажах из 1С и клиентские данные из CRM. 

![006](/GBPowerBI/Pictures/006_018.PNG)

Для задачи вы возьмёте из 1С данные по среднему чеку за период, а из CRM — данные о частоте покупок.

Чтобы связать эти данные, проще всего сделать отдельную таблицу с уникальными названиями клиентов и связать эту таблицу с двумя другими.

У нас получится единая база для анализа из трёх таблиц, где одна вспомогательная.

![006](/GBPowerBI/Pictures/006_001.PNG)

__Важно!__ После настройки связей вы сможете работать с данными в двух таблицах так, как будто это одна таблица.

## Связи в Power BI:
+ автоматически ищутся;
+ найденная автоматически связь делается активной;
+ чем-то похоже на функцию ВПР / VLOOKUP в Excel.

В параметрах можно настроить автоматический поиск связей:

![006](/GBPowerBI/Pictures/006_002.PNG)

Настройка связи выглядит следующим образом:

![006](/GBPowerBI/Pictures/006_003.PNG)

Готовая настроенная связь выглядит так:

![006](/GBPowerBI/Pictures/006_004.PNG)

<hr>

[Содержание](#содержание)

# Кратность и кроссфильтрация
## Основные характеристики связей
### Кратность

![006](/GBPowerBI/Pictures/006_019.PNG)

+ Многие к одному (*:1) — наиболее распространённый тип кратности. У первой таблицы несколько значений, у второй — только уникальное значение в нужном столбце
+ Один к одному (1:1) — у обеих таблиц в связанных столбцах только уникальные значения
+ Один ко многим (1:*) — аналогичная первой связи, только наоборот
+ Многие ко многим (*:*) — в обоих столбцах неуникальные значения.

### Многие ко многим
Сценарий применения связи "многие ко многим" предполагает связывание двух таблиц фактов. 

Две таблицы фактов можно связать напрямую. <br>
Такой прием может быть полезен для быстрого изучения данных.

Основной минус многие ко многим - это отсутствие гибкости.

Как правило многие ко многим применяется редко и не рекомендуется связывать две таблицы фактов напрямую, используя кратность "многие ко многим". <br>
Главная причина в том, что модель будет недостаточно гибкой в плане фильтрации и группировки визуальных элементов в отчете.

Вместо того чтобы связывать таблицы фактов напрямую, мы рекомендуем применять принципы проектирования на основе схемы типа "звезда". Для этого нужно добавить таблицы измерений. Затем они связываются с таблицами фактов связями "один ко многим". Такой подход к проектированию эффективнее, так как делает отчеты более гибкими. Он позволяет выполнять фильтрацию и группирование по любым столбцам измерений, а также суммировать любую связанную таблицу фактов.

<hr>

[Содержание](#содержание)

## Кроссфильтрация

![006](/GBPowerBI/Pictures/006_020.PNG)

+ ### Однонаправленная
    + Стандартный метод, когда фильтрация происходит в таблице, где значения агрегируются.
    + По умолчанию лучше делать связь однонаправленной
    + Быстрее работает
+ ## Двунаправленная
    + Обе таблицы обрабатываются как одна
    + Актуально для таблиц измерений
    + Двунаправленную связь нужно настраивать осознанно, когда вы понимаете зачем

Эта настройка влияет на то, какая из таблиц будет фильтровать связанную таблицу на уровне визуала.

Как это выглядит:

![006](/GBPowerBI/Pictures/006_021.PNG)

<hr>

[Содержание](#содержание)

## Однонаправленная кроссфильтрация
Это наиболее распространенное стандартное направление означает, что фильтрация вариантов в подключенных таблицах выполняется в таблице, где значения агрегируются. 

При импорте модели данных Power Pivot в Excel или более ранней версии все связи будут однонаправленными. Из SQL импорт будет синхронным с источником.

## Двунаправленная кроссфильтрация

При фильтрации обе таблицы обрабатываются так же, как одна. 

Параметр Оба хорошо работает с одной таблицей, которая содержит множество таблиц подстановки, которые его окружают. <br>
Примером может служить таблица фактических данных по продажам с таблицей подстановки для отделов. Такая конфигурация часто называется схемой типа "звезда" (центральная таблица с несколькими таблицами подстановки). 

При наличии нескольких таблиц, у которых также есть таблицы подстановки (некоторые из которых являются общими), не следует использовать параметр Двунаправленная. <br>
Продолжая предыдущий пример, предположим, что в этом случае также есть таблица бюджета, содержащая целевой бюджет для каждого отдела. Таблица отделов подключена к таблице продаж и таблице бюджета. 

Избегайте направления связи Двунаправленная для конфигурации такого вида.

<hr>

[Содержание](#содержание)

# DAX - Data analysis expressions

## Что такое DAX?
DAX - это Data Analysis Expressions (Выражения анализа данных)
+ Это библиотека функций и операторов, которые можно комбинировать для создания формул и выражений в моделях данных Power BI, Analysis Services и Power Pivot в Excel. <br>
Это коллекция функций, операторов и констант, которые можно использовать в формуле или выражении для вычисления и возврата одного или нескольких значений. 
+ Алгоритм функций, похожий на Excel и SQL
+ По DAX существует много качественной документации, каждая формула разобрана на сайте Майкрософт
+ Многие функции доступны из коробки
+ Одно или несколько выражений DAX, используемых для определения вычисления модели, называется формулой (запросом).
+ В DAX можно делать как столбцы, так и виртуальные меры.

![006](/GBPowerBI/Pictures/006_022.PNG)

## Что такое меры?

Что такое Меры и чем они отличаются от столбцов?

![006](/GBPowerBI/Pictures/006_023.PNG)

__Мера__ - это виртуальная расчетная единица, которая отображается в представлении отчетов или представлении данных, но не видна в ячейке или столбца таблицы. <br>
Меры, которые создали пользователи, отображаются в списке «Поля» со значком калькулятора: 

![006](/GBPowerBI/Pictures/006_005.PNG)

Разница между столбцами и мерами:

+ У мер и столбцов можно задавать формат для отображения данных
+ Аналоги ВПР в Excel — это RELATED и LOOKUPVALUE
+ RELATED — возвращает значение из указанного столбца связанной таблицы. 

    __Особенности:__ требует наличия связи между таблицами.

    Плюсы: 
    + очень проста в использовании, не перегружает синтаксис. Удобна для поиска по единственному значению.

    Минусы:
    + сканирует всю таблицу, соответственно, на больших объёмах замедляет быстродействие
    + при поиске значения пренебрегает наложенными фильтрами
    + требует однозначный контекст строки
    + не может использоваться для поиска данных в таблицах с ограниченной связью

+ LOOKUPVALUE — полноценный ВПР, ищет по широкому набору условий, позволяет задавать альтернативный результат.
+ CALCULATE — аналог СУММЕСЛМН. Одна из самых популярных функций, невероятно гибкая и обманчиво простая в использовании. <br>
Позволяет задавать вычисление и указывать, какие фильтры применять.

    Поддерживает типы фильтров:
    + логические
    + фильтры таблиц
    + модификацию фильтров
    
    Особенности: позволяет переводить контекст строки в контекст фильтра, это необходимо для использования в вычислениях-итераторах.

+ DISTINCT — выводит только уникальные значения из столбца
+ DISTINCTCOUNT — считает количество уникальных значений в столбце

На этой лекции вы начнете знакомство с библиотекой DAX (Data Analysis Expressions) - коллекцией функций и операторов, которые можно комбинировать для создания формул и выражений в моделях данных Power BI, Analysis Services и Power Pivot в Excel. 

<hr>

[Содержание](#содержание)

## Синтаксис DAX

__Синтаксис__ — это правила записи формулы, включает различные элементы, которые составляют формулу.

![006](/GBPowerBI/Pictures/006_006.PNG)

1. Имя меры, куда будет записан ответ.
2. Оператор знака равенства ( = ), который обозначает начало формулы.
3. Функция DAX.
4. В скобки () заключается выражение, содержащее один или несколько аргументов. 
5. Имя таблицы, из которой берутся значения.
6. Имя столбца, из которого берутся данные для вычислений.

Редактор DAX в Power BI Desktop помогает создавать синтаксически верные формулы, подсказывая подходящие элементы.

### Синтаксис функции SUM

![006](/GBPowerBI/Pictures/006_008.PNG)

### Синтаксис функции Calculate

![006](/GBPowerBI/Pictures/006_009.PNG)

#### Фильтры функции Calculate

Фильтры позволяют произвести действия с определёнными данными таблицы (столбца).

Фильтры могут быть:
+ выражениями логического фильтра;
+ выражениями фильтра таблицы;
+ функцией изменения фильтра

При наличии множества фильтров они могут применяться с использованием логического оператора «И» (&&), то есть все условия должны выполняться (TRUE) либо логического оператора «ИЛИ» (||), при котором достаточно срабатывания любого из условий.

#### Пример: аналог sumif/суммаесли из Excel
SumIf​

Возможные функции в Power BI:​
+ CALCULATE
+ SUM

![006](/GBPowerBI/Pictures/006_010.PNG)

## Синтаксис функции Divide

![006](/GBPowerBI/Pictures/006_011.PNG)

## Синтаксис функции Distinct

![006](/GBPowerBI/Pictures/006_012.PNG)

## Синтаксис функции Count

![006](/GBPowerBI/Pictures/006_013.PNG)

## Синтаксис функции Distinctcount

![006](/GBPowerBI/Pictures/006_014.PNG)

## Синтаксис функции Countrows

![006](/GBPowerBI/Pictures/006_015.PNG)

## Синтаксис функции Counta

![006](/GBPowerBI/Pictures/006_016.PNG)

## vlookup/ВПР

1. Эта функция менее применима, чем в Excel, так как в Power BI есть связи
2. RELATED — подтягивает связанные значения

LOOKUPVALUE — аналог VLOOKUP​

Related(‘Таблица’[Имя столбца]) — возвращает значение из указанного столбца связанной таблицы

Важно: работает только в том случае, если между таблицами есть связь.

LOOKUPVALUE([столбец, в котором нужное значение], [столбец, по которому искать], условие поиска, альтернативный результат)​
— полноценный ВПР

## Идентичные с Excel

1. if​ - IF
1. Concatenate​ - CONCATENATE
1. Left/Right​ - Left/Right

## VAR
Служебное слово или специальная функция.

Сохраняет результат выражения как именованную переменную, которую затем можно передать в качестве аргумента в другие выражения мер. Вычисленные итоговые значения для выражения переменной не изменяются, даже если на переменную существует ссылка в другом выражении.

Также часто взаимодействует со служебным словом Return, которая заканчивает создание блока переменных и после нее уже идет основной код формулы.

<hr>

[Содержание](#содержание)

# Быстрые меры
Быстрые меры - это преднастроенные меры, которые можно сделать в формате no code/self-service и не писать формулу. При этом формула генерируется автоматически после создания быстрой меры.

Среди быстрых мер есть как часто используемые, так и практически не имеющие широкого применения.

Быстрые меры поделены на 6 категорий:
+ агрегировать по категориям,
+ Фильтры, 
+ Операции со временем,
+ Итоги,
+ Математические операции 
+ Текст

<hr>

[Содержание](#содержание)

## Функции DAX

Функции являются предопределёнными формулами, которые выполняют вычисления с использованием специальных значений, именуемых аргументами, в определённом порядке или структуре. 

Аргументами могут быть другие функции, другие формулы (запросы), выражения, ссылки на столбцы, числа, текст, логические значения, такие как TRUE и FALSE или константы.

Чтобы добавить в формулу функцию, нужно начать вводить её название.

Формулы DAX могут содержать до 64 вложенных функций.

<hr>

[Содержание](#содержание)

### Категории функций DAX

В DAX имеются следующие категории функций: 
+ Дата и время.
+ Логика операций со временем. 
+ Информационные. 
+ Логические. 
+ Математические. 
+ Статистические. 
+ Текстовые.
+ Родительские/дочерние.
+ Прочие. 

Если вы знакомы с функциями в формулах Excel или SQL, многие из функций в DAX будут казаться вам аналогичными.

<hr>

[Содержание](#содержание)

### Операторы DAX
В DAX операторы используются для создания выражений, которые сравнивают значения, выполняют арифметические вычисления или работают со строками.

Существует четыре типа вычислительных операторов: 
+ арифметические: +, — , *, /, ^
+ сравнения: >, <, >=, <=, <>, ==, = 
+ объединения текста: &
+ логические: &&, ||, IN

![006](/GBPowerBI/Pictures/006_007.PNG)

<hr>

[Содержание](#содержание)

[Содержание курса](/GBPowerBI/README.md)
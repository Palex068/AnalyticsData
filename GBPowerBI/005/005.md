# Как подготовить данные их первоисточника к последующему анализу и визуализации

# Содержание

+ [Введение](#введение)
+ [Термины, используемые в лекции](#термины-используемые-в-лекции)
+ [Что такое анализ данных и для чего он нужен](#что-такое-анализ-данных-и-для-чего-он-нужен)
+ [Что такое Power Query](#что-такое-power-query)
+ [Этапы работы с данными](#этапы-работы-с-данными)
+ [Import vs DirectQuery](#import-vs-directquery)
+ [Принципы работы в Power Query](#принципы-работы-в-power-query)
    + [Принцип универсальности](#принцип-универсальности)
    + [Принцип табличности](#принцип-таблчности)
+ [Таблица или не таблица?](#таблица-или-не-таблица)
+ [Что умеет и не умеет Power Query](#что-умеет-и-не-умеет-power-query)
+ [Откуда можно загружать данные в PQ](#откуда-можно-загружать-данные-в-pq)
    + [Популярные источники данных](#популярные-источники-данных)
+ [Универсальный подход к обработке данных](#универсальный-подход-к-обработке-данных)
+ [Типы данных](#типы-данных)
+ [Разбор примера из практики](#разбор-примера-из-практики)
    + [Интерфейс](#интерфейс)
+ [Решаемые задачи](#решаемые-задачи)
+ [Формирование и объединение данных](#формирование-и-объединение-данных)
+ [Типы слияния в Power Query](#типы-слияния-в-power-query)
    + [Добавление](#добавление)
    + [Объединение](#объединение)
        + [Типы объединения](#типы-объединения)
        + [Результаты типов объединений](#результаты-типов-объединений)
+ [Добавление данных в запрос](#добавление-данных-в-запрос)
+ [Ссылки и дублирование запросов](#ссылки-и-дублирование-запросов)
    + [Дублирование](#дублирование)
    + [Ссылка](#ссылка)
    + [Копирование](#копирование)
+ [Работа с датами в PQ](#работа-с-датами-в-pq)
    + [Распознавание дат](#распознавание-дат)
    + [Преобразование дат](#преобразование-дат)
    + [Вычисления с датами](#вычисления-с-датами)
+ [Дополнительные материалы](#дополнительные-материалы)
+ [Практика: перейдем в интерфейс Power BI и произведем загрузку данных с сайта ЦБ РФ](#практика-перейдем-в-интерфейс-power-bi-и-произведем-загрузку-данных-с-сайта-цб-рф)
    + [Порядок обработки данных](#порядок-обработки-данных)

+ [Практическая работа на семинаре](#практическая-работа-на-семинаре)
    + [Викторина](#викторина)
    + [Практика](#практика-на-семинаре)
+ [Домашнее задание](#домашнее-задание)

[Содержание курса](/GBPowerBI/README.md)

# Введение

На этой лекции вы найдете ответы на такие вопросы как / узнаете:

+	Что такое Power Query
+	Что является таблицей, принцип табличности
+	Источники данных
+	Импорт данных
+	Универсальный порядок шагов в преобразовании данных
+	Типы данных
+	Формирование и объединение данных

<hr>

[Содержание](#содержание)

# Термины, используемые в лекции

__Power Query (PQ)__ — это технология подключения к данным. С её помощью можно обнаруживать, подключать, объединять и уточнять данные из разных источников для последующего анализа. Функции Power Query доступны в классических версиях Excel и Power BI.

__Анализ данных__ — средство проверки гипотез и решения задач для исследователя данных.

__Аналитик__ — специалист в области анализа данных, который на достаточной уровне владеет инструментальными и программными средствами анализа данных.

__Создание набора данных__ — этап исследования, в котором данные нужно загрузить и подготовить к анализу.

__Моделирование данных__ — этап исследования, в котором данные нужно проанализировать (найти ответы на стоящие вопросы).

__Подключение__ — создание подключений к данным, которые хранятся в облаке, в какой-либо службе или на локальном компьютере.

__Преобразование__ — трансформация или формирование данных в соответствии с поставленной задачей.

__Шаги запроса__ — итерации при работе в PQ, формирующие загрузку, трансформацию и выгрузку данных.

__Добавление запросов__ — стыковка двух и более таблиц с одинаковым наименованием столбцов. В Power Query операция добавления создаёт новый запрос, содержащий все строки из первого запроса, за которым следуют все строки из второго запроса. 

__Объединение запросов__ — это поиск и подстановка данных одной таблицы в другую по заданным параметрам.

<hr>

[Содержание](#содержание)

# Что такое анализ данных и для чего он нужен

Анализ данных — достаточно широкое понятие, оно насчитывает множество определений. Как пользователи Power Query, выделим для себя одно: 

__Анализ данных__ — это средство проверки гипотез и вопросов, которые ставит перед нами наша деятельность, а также их решения.

__Важно!__ Всегда следует помнить: сами по себе гипотезы и вопросы в данных не содержатся. Если нам,  как аналитикам, не хватает экспертности в данном бизнесе, нужно работать вместе с экспертом области, которую мы исследуем. 

__Эксперт__ — ключевая фигура в процессе анализа. 

__Аналитик__ — связующее звено между экспертами и данными. Он собирает у экспертов гипотезы, а затем выдвигает требования к данным. 

Эффективные аналитические решения можно получить при взаимодействии ЭКСПЕРТ-ГИПОТЕЗА-АНАЛИТИК.

Исключая научную часть исследования данных, задача аналитика — помочь руководителю в принятии управленческого решения. <br>
Например:
+ рассчитать эффективность (рентабельность) работы сети магазинов,
+ просчитать окупаемость закупки,
+ сегментировать клиентов,
+ рассчитать, была ли акция успешной,
+ проверить, влияет ли доход клиента на кредитоспособность и так далее.

<hr>

[Содержание](#содержание)

# Что такое Power Query

+ __Power Query__ - это инструмент, который позволяет подключиться к источнику данных и их преобразования
+ Power Query превращает не табличные данные в табличные
+ С помощью Power Query можно создавать ETL процесс (Extract, Transform, Load = «извлечение, преобразование, загрузка»)
+ Доступен в Excel и Power BI
+ Помогает автоматизировать рутинные функции по подготовке данных (Аналитики тратят до 80% времени на подготовку данных), например
+ транспонирует таблицу,
+ группирует,
+ проставляет форматы данных для столбцов,
+ удаляет пустые значения и ошибки,
+ форматирует столбцы

Есть возможность писать запросы на языке М

<hr>

[Содержание](#содержание)

# Этапы работы с данными
При верхнеуровневом подходе к исследованию данных, его можно разделить на два этапа:
+ создание набора данных и
+ моделирование. 

__Создание набора данных__ — этап исследования, в котором данные нужно загрузить и подготовить к анализу. <br>
Данные, которые агрегируются в компаниях в различных источниках (например, в базах данных), часто имеют свои особенности, так как редко накапливаются для решения задач анализа, а скорее для коммерческих целей:
+ ведения учёта,
+ составления отчётности.

Такие данные, как правило, содержат ошибки, аномалии, противоречия. 

Следовательно, одна из ___прикладных задач аналитика___ — это подготовка качественных данных для анализа. 

Под качественными будем понимать полные и достоверные данные. 

Ещё одна задача аналитика — это работа с большими объёмами данных, которые, например, Excel уже не способен обрабатывать.

__Важно!__ Технология Power Query на данном этапе помогает справится с поставленными задачами.

Задачи решаемые на этапе создания набор данных:
+ __выбор данных__ — подключение к источнику данных;
+ __очистка данных__ — преобразование и приведение данных к нужному виду;
+ __загрузка данных__ — определение того, какие именно таблицы необходимо загружать;
+ после подготовки данных необходимо приступать к __моделированию__ — этапу исследования, в котором данные анализируются (ищутся ответы на стоящие вопросы).

<hr>

[Содержание](#содержание)

# Import vs DirectQuery

Import и DirectQuery – это способы забора данных в Power BI:

| Import: | DirectQuery: |
|---------|--------------|
| загружает все данные из базы внутрь Power BI; |запрашивает данные напрямую из источника; | 
| больше весит файл pbix; | файл pbix весит мало; |
| подходит для работы с данными внутри Power BI.| вся работа с данными должна быть проделана до Power BI.|
| Лучше по скорости работы с данными | Подходит для версий on premise |
| Нет ограничений по работе в DAX | Real-time обновление данных из источника |

Выбор 	метода забора данных необходимо сделать при загрузке данных из крупного источника, например, SQL Server:

![005](/GBPowerBI/Pictures/005_001.png)

По умолчанию Import лучше для полноты функционала Power BI, мы будем практиковаться именно с ним.

## Пример архитектуры с Direct Query

![005](/GBPowerBI/Pictures/005_032.PNG)

Ключевое отличие - это этап преобразования данных в Olap кубах, для Direct query все преобразования должны быть сделаны до Power BI, Olap кубы или многомерные кубы - это один из вариантов


<hr>

[Содержание](#содержание)

# Принципы работы в Power Query

Общую логику работы в Power Query можно представить следующим образом: сначала мы загружаем данные в Power Query, потом приводим в нужный вид, а затем выгружаем. 

В будущем данные итерации можно повторить, просто обновив запрос. 

Работая с этим алгоритмом действий, следует придерживаться двух принципов: 
+ универсальности;
+ табличности.

<hr>

[Содержание](#содержание)

## Принцип универсальности
Работа с шагами запроса в Power Query должна быть максимально универсальной. То есть мы должны стремится к таким решениям, чтобы при изменении исходных данных не менять запрос.

<hr>

[Содержание](#содержание)

## Принцип табличности
Все данные после проработки в  Power Query должны быть выгружены в виде таблиц.

Таблица — это способ структурирования данных по правилам:
+ одна строка = одно событие или объект;
+ столбцы содержат сравнимые показатели;
+ для данных в столбце осмысленная арифметическая операция;
+ нет объединений;
+ таблица состоит из списка заголовков и списка списков значений.

Далее мы изучим несколько примеров не таблиц.

<hr>

[Содержание](#содержание)

# Таблица или не таблица?

![005](/GBPowerBI/Pictures/005_022.jpg)

Это не таблица, потому что нужно убрать итоговые значения

![005](/GBPowerBI/Pictures/005_022.jpg)

Это не таблица, потому что нужно заполнить пустые значения

![005](/GBPowerBI/Pictures/005_024.png)

Это не таблица, потому что нужно перенести значение по марту, июлю и августу на отдельные строки

![005](/GBPowerBI/Pictures/005_025.jpg)

Формально таблица, но с плохой структурой данных

![005](/GBPowerBI/Pictures/005_026.jpg)

Это не таблица, потому что есть группировка по годам - их нужно вынести отдельным признаком в столбец

![005](/GBPowerBI/Pictures/005_027.png)

Формально будет таблицей, если Power BI - это заголовок столбца.

<hr>

[Содержание](#содержание)

# Что умеет и не умеет Power Query
Чтобы лучше понимать, какие задачи предстоит решать в Power Query, разберём, какие манипуляции с данными здесь __можно__ проводить:
1.	Загружать данные почти из любых источников: файлов, баз данных, интернета и так далее.
2.	Собирать данные из нескольких листов, папок, файлов. Консолидировать данные из разных источников (например, из папки).
3.	Трансформировать загруженные данные — производить итерации типа сортировки,  фильтрации, группировки, сворачивания или разворачивания столбцов  по заданному признаку и многое другое.
4.	Связывать и объединять таблицы между собой. Формировать данные на основании нескольких уже загруженных таблиц.
5.	Работать с датами и текстом. Производить итерации типа зачистки, исправления регистра, удаления лишних пробелов, вычисления длины строки и так далее.
6.	Выполнять простые вычисления с данными. Производить арифметические операции со столбцами, вычислять среднее, а также другие простые операции, включая логику ЕСЛИ.

При этом мы __не можем__ сделать следующее:
1.	Редактировать данные, загруженные напрямую. То есть, менять данные нужно в источнике, из которого они загружаются. 
2.	Выполнять сложные статистические и математические расчёты. Сумму, среднее, медиану и другие простые вычисления можно произвести, однако сложные финансовые вычисления — нет. После выгрузки данных из PQ в PB их можно добавить. Но это уже  дальнейшая работа с формулами Dax.
3.	Визуализировать — Power Query не про визуализацию, а про данные. Наглядно представить данные диаграммами можно на следующих этапах работы в Power BI (после выгрузки данных из PQ в PB).

Одна из основных ценностей Power Query в том, что он преобразовывает таблицы для дальнейшего анализа.

<hr>

[Содержание](#содержание)

# Откуда можно загружать данные в PQ
__Базы данных__ — наиболее лёгкий и удобный путь получения информации, так как уже содержит упорядоченные данные. PQ умеет работать с большинством баз данных: Oracle, MySQL, Microsoft SQL Server, PostgreSQL,MongoDB, Microsoft Access и так далее.

__Интернет__ — в Power Query есть возможность подгружать нужные данные из веб-страниц.

__ERP,CRM__ — по умолчанию PQ умеет запрашивать и соединять данные из распространённых программ (SAP, Microsoft Dynamics) и CRM-системы Salesforce. <br>
1С поддерживают обмен данными по протоколу OData (Open Data Protocol) — специально разработанному открытому набору правил для запросов и обновления данных между компьютерами по сети.

__Файлы:__
+ данные из файлов Microsoft Excel любых типов: XLS, XLSX, XLSB, XLSM;
+ общепринятые веб-форматы: HTML, XML, JSON;
+ обычный TXT или разделённый запятыми или точкой с запятой CSV;
+ возможен импорт из PDF (с промежуточным этапом в виде распознавания PDF в Microsoft Word). 

В Power BI есть коннекторы к десяткам систем

![005](/GBPowerBI/Pictures/005_028.jpg)

## Загрузка данных

![005](/GBPowerBI/Pictures/005_029.PNG)

## Популярные источники данных

![005](/GBPowerBI/Pictures/005_030.PNG)

## Метод загрузки данных в Power BI

![005](/GBPowerBI/Pictures/005_031.jpg)

<hr>

[Содержание](#содержание)

# Универсальный подход к обработке данных

__Алгоритм создания набора данных__
1. Выбор данных<br>
Подключаемся к источнику данных
2. Трансформация (очистка) данных<br>
Приводим данные к необходимому виду
3. Загрузка данных<br>
Определяем, какие именно данные в табличном виде понадобятся к загрузке

__Важно!__ На первом этапе не идет речь про настройку обновления данных.

<hr>

[Содержание](#содержание)

# Типы данных
Какие есть типы данных?

В большинстве импортируемых наборов данных содержится более одного типа данных.​ 

Глобально у нас 3 группы данных:
+ качественные,
+ числовые,
+ дата.

Power BI, как и Excel, поддерживает различные типы данных:​
1. целое число​
2. десятичное число​
3. десятичное число с фиксированной запятой​
4. дата и время​
5. дата​
6. время​
7. текст​
8. истина/ложь​
9. двоичный​

От выбранного типа зависит набор операций, которые можно будет выполнить с этими данными.​

Например, для числовых данных доступны:
+ суммирование,
+ определение среднего арифметического,
+ отображение максимального и минимального значений,
+ определение количества пустых и уникальных значений, 
+ стандартное отклонение и др.​

![005](/GBPowerBI/Pictures/005_048.png)

<hr>

[Содержание](#содержание)

# Разбор примера из практики

## Интерфейс

1. ― кнопки на ленте, которые позволяют взаимодействовать с данными в запросе.
2. ― список запросов (по одному для каждой таблицы или сущности). Их можно выбирать, просматривать и настраивать.
3. ― рабочая область, где отображаются данные из выбранного запроса, которые можно настраивать.
4. ― параметры запроса, где перечислены свойства запроса и применённые действия.

![005](/GBPowerBI/Pictures/005_021.png)

Данные находятся в нетабличном виде, так как есть объединения, количество и выручка в текстовом формате и так далее.

Задача — привести данные в табличный вид.

![005](/GBPowerBI/Pictures/005_002.png)

## Алгоритм действий:
1.	Транспонируем данные. 

![005](/GBPowerBI/Pictures/005_003.png)

2.	Заполняем в колонке с периодом (первой) значения, кнопками ВНИЗ, затем ВВЕРХ.
3.	Объединяем первый и второй столбец (колонку с периодом и наименованием значений) через любой пользовательский символ.

![005](/GBPowerBI/Pictures/005_004.png)

4.	Транспонируем данные. 
5.	Повышаем заголовок (кнопкой «Использовать первую строку в качестве заголовка»).
6.	Отменяем свёртывание других столбцов.

![005](/GBPowerBI/Pictures/005_005.png)

7.	Разъединяем столбец «Атрибут».
8.	Меняет формат данных на текстовый у столбца с периодом.
9.	Производим итерацию «Столбец сведения».
10.	Меняем заголовки таблицы.

![005](/GBPowerBI/Pictures/005_006.png)

<hr>

[Содержание](#содержание)

# Решаемые задачи

1.	Данные находятся в разных таблицах. <br>
Например, мы работаем в организации с сетью магазинов по всей стране. Каждый магазин формирует свой файл по продажам, и нам необходимо консолидировать данные.
2.	Результат одного запроса может быть исходным для другого. <br>
Например, если у нас есть консолидированные данные, но необходимо, не меняя источник, исключить, например, Москву.

<hr>

[Содержание](#содержание)

# Формирование и объединение данных

Формировать и объединять данные в Power BI можно с помощью встроенного редактора Power Query.

__Формирование данных__ — это преобразование данных, например переименование столбцов или таблиц, замена текста числами, удаление строк, установка первой строки в качестве заголовков и т. д.

__Объединение данных__ — это подключение к нескольким источникам данных, формирование данных в соответствии с потребностями и их последующее объединение в один удобный запрос.

В Power Query отдельные таблицы с данными называются запросами.

![005](/GBPowerBI/Pictures/005_049.png)

## Способы объединения данных

С помощью Power Query объединить несколько источников данных (например, несколько таблиц MS Excel) можно двумя способами:

+ Добавление таблицы под таблицу <br>
Такой подход возможен, если таблицы имеют одинаковую структуру и заголовки (шапки)

![005](/GBPowerBI/Pictures/005_050.png)

+ Слияние таблиц <br>
Подход применяется в случае, если содержание одной таблицы дополняет содержание другой, а таблицы имеют разные заголовки (шапки).

![005](/GBPowerBI/Pictures/005_051.png)

<hr>

[Содержание](#содержание)

# Типы слияния в Power Query
В PQ существует два типа слияния запросов (таблиц) — объединение и добавление.

Обе команды доступны на вкладке «Главная» либо при создании нового вопроса в соответствующем пункте меню. То есть операцию и объединения, и добавления можно произвести, как создавая новый запрос на основании уже имеющихся (не производить итераций над уже имеющимися запросами), так и путём итераций над запросами (добавляя и объединяя с существующим запросом другие).

![005](/GBPowerBI/Pictures/005_007.png)

<hr>

[Содержание](#содержание)

## Добавление 
Главная задача, которую решает добавление запросов (таблиц) — это автоматическая консолидация нескольких таблиц (например, нескольких листов одной книги Excel, нескольких таблиц из разных книг, консолидация запросов из разных источников и так далее).

__Важно!__ Добавлять можно 2 и более таблиц. Названия добавляемых столбцов не должны совпадать. Порядок и количество столбцов в каждой таблице могут быть различными. 

![005](/GBPowerBI/Pictures/005_008.png)

Если у нас есть несколько таблиц с разными наименованиями столбцов, то добавление консолидирует данные тех столбцов, наименования которых совпадают. А тех, которые не совпадают, добавит справа в общем запросе.

<hr>

[Содержание](#содержание)

## Объединение

Основная задача, которую решает объединение — это поиски и подстановка данных одной таблицы в другую по заданным параметрам. <br>
Например, объединение запросов по левому внешнему соединению — это аналог функции ВПР в Excel.

__Важно!__ Названия столбцов не имеют значения. 

Объединение можно производить как по одному столбцу, так и по связке нескольких столбцов.

В Power Query есть несколько способов объединения: 
+ внешнее левое,
+ внешнее правое и так далее.

Объединение за один раз можно произвести только с двумя таблицами, то есть если мы хотим объединить информацию из трёх таблиц (запросов), то нам придётся сделать два объединения.

Объединение таблиц (запросов) происходит по ключу — тому столбцу, который есть и в первой таблице, и во второй. Или по связке таких столбцов.

<hr>

[Содержание](#содержание)

### Типы объединения

![005](/GBPowerBI/Pictures/005_052.PNG)

Разберём типы всех объединений в Power Query на примере двух простых таблиц.

![005](/GBPowerBI/Pictures/005_009.png)

![005](/GBPowerBI/Pictures/005_010.png)

__Внешнее слева__ — аналог функции ВПР в Excel. В результате объединения двух таблиц получим все элементы из «Таблицы1» и в дополнительном столбце найденные совпадения из «Таблицы2». Данный тип соединения часто используется в работе с данными.

![005](/GBPowerBI/Pictures/005_011.png)

__Внешнее справа__ — в результате объединения с данными из «Таблицы2» найдутся совпадающие данные «Таблицы1». Это обратный вариант соединения «внешнее слева».

![005](/GBPowerBI/Pictures/005_012.png)

__Анти-соединение слева__ — результат соединения, те позиции, которые есть в «Таблице1» и при этом отсутствуют в «Таблице2».

![005](/GBPowerBI/Pictures/005_013.png)

__Анти-соединение справа__ — выводит данные «Таблицы2» за вычетом данных из «Таблицы1».

![005](/GBPowerBI/Pictures/005_014.png)

__Внутреннее__ — тип слияния выводит только совпадающие данные в двух таблицах.

![005](/GBPowerBI/Pictures/005_015.png)

__Полное внешнее__ — выводит данные из обеих таблиц. То есть те, что совпадают, встанут друг напротив друга в одной строке, а остальные будут иметь в паре NULL.

<hr>

[Содержание](#содержание)

### Результаты типов объединений

![005](/GBPowerBI/Pictures/005_016.png)

![005](/GBPowerBI/Pictures/005_017.png)

<hr>

[Содержание](#содержание)

# Добавление данных в запрос

1. Загрузите в качестве источников данных необходимые файлы.
2. Перейдите в редактор Power Query.
3. Нажмите правой кнопкой мыши области Запросы.
4. Выберите Новый запрос → Объединить → Добавить запросы в новый.
5. Выберите таблицы для объединения строк из двух таблиц в одну.
6. Нажмите ОК.
7. Дайте название новой таблице.

![005](/GBPowerBI/Pictures/005_053.png)

Перед выходом из редактора нажмите Закрыть и применить, чтобы сохранить изменения.

![005](/GBPowerBI/Pictures/005_054.PNG)

<hr>

[Содержание](#содержание)

# Ссылки и дублирование запросов

Есть ещё ряд полезных итераций с запросами: дублирование, ссылка на запрос или копирование запроса. Все эти итерации доступны, если щёлкнуть правой кнопкой мыши на запрос в PQ.

![005](/GBPowerBI/Pictures/005_018.png)

Данные манипуляции решают ряд задач. Разберём их ниже.

<hr>

[Содержание](#содержание)

## Дублирование 
Например, у есть запрос, состоящий из множества шагов, но нам необходимо те же шаги сделать в другой таблице (изменить источник данных). Для этого необходимо дублировать исходный запрос и с помощью настроек изменить источник данных.<br>
__Важно!__ При дублировании запросы совершенно независимы друг от друга, то есть правки, вносимые в один из запросов, не повлияют на другой.

<hr>

[Содержание](#содержание)

## Ссылка
Например, у нас есть консолидированные данные в одном общем запросе.

Один руководитель просит сделать одни расчёты с этими данными, второй — совершенно другие. В этой ситуации можно сделать две ссылки из главного источника данных и на их основании построить нужные отчёты.

__Важно!__ Ссылается на другой запрос, делая его источником, то есть при изменении шагов запроса-источника, поменяются данные и в запросах-ссылках.

<hr>

[Содержание](#содержание)

## Копирование 
Команда «копировать» работает аналогично дублированию, однако есть ключевое различие. 

Если применить копирование к обычному запросу, который никак не связан с другими запросами, мы получим просто его копию. Однако если запрос имеет связи, то копирование создаст копию запроса и всех влияющих на него связей.

<hr>

[Содержание](#содержание)

# Работа с датами в PQ
PQ легко справляется с задачами при работе с данными типа «Дата» и «Дата и Время». 

За эти преобразования отвечают кнопки «Дата» и «Время», находящиеся на вкладках «Преобразование» и «Добавление столбца».

Задачи которые можно решить:
1.	Извлечь из даты отдельные составляющие (день, месяц, год, квартал и так далее);
2.	Определить номер недели по дате;
3.	Произвести вычисления.

<hr>

[Содержание](#содержание)

## Распознавание дат
Почти все текстовые форматы записи дат распознаются стандартными средствами PQ, даже если дата была записана в обратной последовательности. <br>
__Важно!__ Не распознаются даты, если они идут в другом региональном формате, а ваш ПК имеет стандартные российские настройки (и наоборот). В этом случае необходимо воспользоваться командой «Используя локаль»:

![005](/GBPowerBI/Pictures/005_019.png)

<hr>

[Содержание](#содержание)

## Преобразование дат
Есть целый ряд возможностей преобразования дат в PQ.

__Раздел «День»__
+ День — номер дня в месяце.
+ День недели — порядковый номер дня недели, начиная с нуля, т. е. Пн=0, Вт=1 и т. д. 
+ День года — порядковый номер дня в году.
+ Начало дня — дата-время начала дня (полночь).
+ Конец дня — дата-время начала следующего дня (полночь).
+ Название дня — день недели словом.

__Раздел «Неделя»__
+ Неделя года — номер недели в году. 
Важно! Power Query использует нумерацию недель по американскому стандарту, который отличается от принятого в России и Европе стандарта ISO 8601. 
+ Неделя месяца — порядковый номер (начиная с 1) недели в месяце.

__Раздел «Квартал»__
+ Квартал года — номер квартала в году числом от 1 до 4. 
+ Начало квартала — дата первого дня квартала.
+ Конец квартала — дата последнего дня квартала.

__Раздел «Месяц»__
+ Месяц — номер месяца от 1 до 12.
+ Начало месяца — дата первого дня текущего месяца и года.
+ Дней в месяце — количество дней в месяце от 28 до 31.
+ Название месяца — название месяца словом.
+ Конец месяца — дата последнего дня месяца

__Раздел «Год»__
+ Год — номер года в числовом формате.
+ Начало года — дата первого дня (1 января) текущего года.
+ Конец года — дата конца года.

<hr>

[Содержание](#содержание)

# Вычисления с датами
Часто встречающаяся задача — это вычисление разницы между двумя датами:
+ возраст,
+ стаж,
+ срок хранения,
+ длительность доставки и так далее. 

PQ легко работает с такими вычислениям путём простых арифметических операций.<br>
__Важно!__ В PQ есть тип данных «Продолжительность» для хранения длительности и продолжительности какого-либо процесса. 

Когда мы производим арифметические операции с датами, результатом будет тип данных «Продолжительность». 

Для дальнейшего форматирования и преобразования этого типа данных, на вкладке преобразования используйте выпадающий список «Продолжительность».

![005](/GBPowerBI/Pictures/005_020.png)

Частным случаем подсчёта длительности является вычисление возраста (разницы между сегодня и датой рождения). Для этого вычисления существует отдельный пункт меню «Возраст», который вычисляет, сколько дней, часов, минут, секунд прошло с даты рождения. Чтобы привести к необходимому формату, надо воспользоваться пунктом меню «Продолжительность».

<hr>

[Содержание](#содержание)

# Дополнительные материалы
+ [Power Query — обзор и обучение](https://support.microsoft.com/ru-ru/office/power-query-%E2%80%94-%D0%BE%D0%B1%D0%B7%D0%BE%D1%80-%D0%B8-%D0%BE%D0%B1%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-ed614c81-4b00-4291-bd3a-55d80767f81d)
+ [Подключение к данным](https://docs.microsoft.com/ru-ru/power-bi/fundamentals/desktop-what-is-desktop)
+ [Блог Power Bi](https://powerbi.microsoft.com/ru-ru/blog/)
+ [Power query](https://learn.microsoft.com/ru-ru/powerquery-m/m-spec-introduction)

<hr>

[Содержание](#содержание)

# Практика: перейдем в интерфейс Power BI и произведем загрузку данных с сайта ЦБ РФ

## Порядок обработки данных
1. Запрос к источнику данных состоит из 4х этапов:
    + Загрузка данных 
    + Обработка/Трансформация 
    + Выгрузка данных 
    + Обновление данных (!)

2. Работа с шагами запроса должна быть максимально универсальной
3. Мы должны стремится к таким решениям, чтобы при изменении исходных данных не менять запрос, например учесть все варианты написания телефона, даже если какие-то примеры отсутствуют в текущих данных: номер телефона может начинаться с +7, 8 или сразу с 9, разделять цифры может пробел или “-”
4. Для того, чтобы обновление работало структура данных не должна меняться: порядок столбцов, названия столбцов, название файла или витрины

Важно! Добавление этапа обновления данных меняет весь подход.

## Практика

1. Найдем в поиске результаты по запросу "cbrf курс валют на заданную дату"

![005](/GBPowerBI/Pictures/005_033.PNG)

2. Перейдем по первому результату

![005](/GBPowerBI/Pictures/005_034.PNG)

Это таблица с данными по курсам валют за текущую и предыдущие даты

3. Копируем URL

![005](/GBPowerBI/Pictures/005_035.PNG)

4. Переходим в PowerBI, выбираем Получить данные

![005](/GBPowerBI/Pictures/005_036.PNG)

5. Другое -> Интернет

![005](/GBPowerBI/Pictures/005_037.PNG)

6. Вбиваем адрес

![005](/GBPowerBI/Pictures/005_038.PNG)

7. В данном случае вторая таблица, это то что нам нужно

![005](/GBPowerBI/Pictures/005_039.PNG)

8. Выбираем эту таблицу и нажимаем загрузить

![005](/GBPowerBI/Pictures/005_040.PNG)

Во вкладке Данные у нас появилась Таблица 2, нажимаем на троеточие и выбираем Изменить запрос

![005](/GBPowerBI/Pictures/005_041.PNG)

9. Открывается инструмент Редактор Power Query

![005](/GBPowerBI/Pictures/005_042.PNG)

10. Переименуем таблицу в Курсы валют

![005](/GBPowerBI/Pictures/005_043.PNG)

11. Удалим столбец Цифр. код, т.к. он нам не понадобиться

![005](/GBPowerBI/Pictures/005_044.PNG)

12. Отсортируем Курсы валют по убыванию

![005](/GBPowerBI/Pictures/005_045.PNG)

13. После внесенных изменений, если нас всё устраивает нажимаем Закрыть и применить, для повторной загрузки данных

![005](/GBPowerBI/Pictures/005_046.PNG)

14. Теперь таблица загрузилась в необходимом нам виде

![005](/GBPowerBI/Pictures/005_047.PNG)


<hr>

[Содержание](#содержание)

# Практическая работа на семинаре

## Викторина

Что не умеет делать Power Query?

+ Загружать данные 
+ Консолидировать данные из нескольких листов, папок, файлов​
+ Трансформировать загруженные данные
+ <mark>__Редактировать загруженные данные (Ответ)__
+ Объединять таблицы между собой
+ Форматировать столбцы

Какого коннектора нет в Power BI?

+ <mark>__1C (Ответ)__
+ Google analytics
+ MySQL
+ Teradata
+ Salesforce
+ Excel

Какого типа данных нет в Power BI?

+ целое число​
+ десятичное число​
+ десятичное число с фиксированной запятой​
+ дата и время​
+ дата​
+ время​
+ текст​
+ <mark>__бинарный (Ответ)__
+ истина/ложь​
+ двоичный​

Сколько есть способов объединения данных?

+ 1
+ 2
+ 3
+ 4
+ 5
+ <mark>__6 (Ответ)__
+ 7
+ 8
+ 9
+ 10

Какие есть методы загрузки данных в Power BI и чем они отличаются?

<mark>__Import и Direct query.__

Какой тип объединения данных изображен ниже?

![005](/GBPowerBI/Pictures/005_055.PNG)

<mark>__Антисоединение слева. Остаются только строки, уникальные только для первой таблицы.__

Из каких этапов состоит запрос к источнику данных?

1. Загрузка данных 
2. Обработка/Трансформация 
3. Выгрузка данных 
4. Обновление данных

<hr>

[Содержание](#содержание)

## Практика на семинаре

### Задание №1
Скачайте данные по ссылке: [PQ - Google Таблицы](https://docs.google.com/spreadsheets/d/1E3TwxSZYDV2fYvYdMBr1Ci_LvfDznEpsZ11jFOo5eZk/export?format=xlsx)

1. Создадим новый файл в Power BI
2. Нажимаем Главная -> Получить данные -> Другое -> Интернет
3. Вставляем ссылку на [файл](https://docs.google.com/spreadsheets/d/1E3TwxSZYDV2fYvYdMBr1Ci_LvfDznEpsZ11jFOo5eZk/export?format=xlsx)

![005](/GBPowerBI/Pictures/005_056.PNG)

### Задание №2

Задача: привести данные в табличный вид:
+ сгруппировать выручку по классам 
+ Удалить строки, содержащие «Итого» 
+ Сделать замену 
+ Сгруппировать: в одном столбце оставить по одному значению 

1. После загрузки данных переходим Главная -> Преобразование данных <br>
Открывается редактор Power Query

![005](/GBPowerBI/Pictures/005_057.PNG)

2. Первая строка Таблицы 0 это заголовки столбцов, включим это 

![005](/GBPowerBI/Pictures/005_058.PNG)

3. В столбце Класс уберем все строки со значением NULL

![005](/GBPowerBI/Pictures/005_059.PNG)

![005](/GBPowerBI/Pictures/005_060.PNG)

4. Для дальнейшей работы нам нужно изменить значения в столбце Сумма зарплат, так как Power BI как разделитель использует запятую, а здесь точка

5. На столбце Сумма зарплат кликаем правой кнопкой мыши и выбираем Замена значений

![005](/GBPowerBI/Pictures/005_061.PNG)

6. Настраиваем правила для замены

![005](/GBPowerBI/Pictures/005_062.PNG)

7. Теперь выделяем столбец, переходим Преобразование -> Тип данных -> Десятичное число

![005](/GBPowerBI/Pictures/005_063.PNG)

8. Применим группировку: Главная -> Группировать по -> 

![005](/GBPowerBI/Pictures/005_064.PNG)

![005](/GBPowerBI/Pictures/005_065.PNG)

### Задание №3

Задача:
+ привести данные в табличный вид,
+ просчитать количество клиентов
+ Заполнить строки
+ Убрать пробелы
+ Привести данные в столбце « Клиент» к единому формату
+ Посчитать количество клиентов у менеджеров
+ Отсортировать по убыванию

1. Обратим внимание, что в таблице много пустых значений, выберем столбец клиент и исключим нулевые значения

![005](/GBPowerBI/Pictures/005_066.PNG)

Можно было использовать меню Главная -> Удалить строки -> Удалить пустые строки
<hr>

2. Мы имеем пустые значения после поля с ФИО руководителя, применим функцию Заполнить -> Вниз

![005](/GBPowerBI/Pictures/005_067.PNG)

![005](/GBPowerBI/Pictures/005_068.PNG)

3. Обратим внимание на написание ФИО клиентов, они написаны по-разному

![005](/GBPowerBI/Pictures/005_069.PNG)

ПКМ на столбец Клиент -> Преобразование -> Каждое Слово С Прописной

![005](/GBPowerBI/Pictures/005_070.PNG)

4. Посчитаем количество клиентов у руководителя, произведем группировку 

![005](/GBPowerBI/Pictures/005_071.PNG)

5. Отсортируем по убыванию

![005](/GBPowerBI/Pictures/005_072.PNG)

### Задание №4

+ Привести данные в табличный вид 
+ Разделить столбец «Выручка» 
+ Умножить на 1000
+ Убрать пробелы 
+ Разделить столбец «Период»

1. Начнем с удаления пустых строк

![005](/GBPowerBI/Pictures/005_073.PNG)

2. Сделаем первую строку заголовком

![005](/GBPowerBI/Pictures/005_074.PNG)

3. Разделим столбец "Период"

ПКМ на заголовке столбца -> Разделить столбец -> По разделителю...

![005](/GBPowerBI/Pictures/005_075.PNG)

Раскрываем Расширенные параметры выбираем Разделение на строки

![005](/GBPowerBI/Pictures/005_076.PNG)

ПКМ -> Преобразование -> Усечь (убираем лишние пробелы)<br>
ПКМ -> Преобразование -> Каждое Слово С Прописной (приводим к стандартному виду)

4. Нам необходимо убрать мягкий знак в месяце Июль, для этого идём Преобразование -> Извлечь -> Первые символы 

![005](/GBPowerBI/Pictures/005_077.PNG)

![005](/GBPowerBI/Pictures/005_078.PNG)

5. Теперь из значений столбца Выручка удалим букву "к" на конце

ПКМ -> Замена значений -> меняем "к" на пустое место

![005](/GBPowerBI/Pictures/005_079.PNG)
![005](/GBPowerBI/Pictures/005_080.PNG)

ПКМ -> Замена значений -> меняем "." на "," для преобразование типа в число

![005](/GBPowerBI/Pictures/005_081.PNG)

6. Изменим тип данных на Десятичное число

![005](/GBPowerBI/Pictures/005_082.PNG)

7. Умножим все значения на 1000, для этого идем Преобразования -> Стандартный -> Умножить -> вставляем 1000

![005](/GBPowerBI/Pictures/005_083.PNG)

8. Необходимо исправить выручки разделенных строк "Фев, Мар" и "Июн, Июл, Авг"

Добавим условный столбец 

![005](/GBPowerBI/Pictures/005_084.PNG)

Добавим настраиваемый столбец

![005](/GBPowerBI/Pictures/005_085.PNG)

Округлим получившиеся значения

![005](/GBPowerBI/Pictures/005_086.PNG)

9. Удалим ненужные столбцы

![005](/GBPowerBI/Pictures/005_087.PNG)

Результат

![005](/GBPowerBI/Pictures/005_088.PNG)

### Задание №5

Вынести признак квартала и года в отдельные столбцы и значения в отдельный столбец

1. Удаляем пустые строки

2. Выделим свернутые строки и Отменим свертывание столбцов

![005](/GBPowerBI/Pictures/005_089.PNG)

Результат

![005](/GBPowerBI/Pictures/005_090.PNG)

3. Из столбца Атрибут сделаем два столбца Квартал и Год: ПКМ -> Разделить столбец -> По разделителю

![005](/GBPowerBI/Pictures/005_091.PNG)

![005](/GBPowerBI/Pictures/005_092.PNG)

4. Переименуем столбцы

![005](/GBPowerBI/Pictures/005_093.PNG)

### Задание №6 (дополнительный)

Сделайте структуру таблицы такой, чтобы столбцы были следующие:
+ Продавец
+ Выручка
+ Кол-во

1. Удалим пустые строки

2. Перейдем Преобразование -> Столбец сведения

![005](/GBPowerBI/Pictures/005_094.PNG)

Нажимаем применить и закрыть, данные закачиваются снова и мы имеем необходимые нам таблицы

# Домашнее задание

1. Скачайте по ссылке данные из CRM и Справочник: https://docs.google.com/spreadsheets/d/1vev2uOhVs4PS7vMxLRWi9DocrlWGSj8I/export?format=xlsx
2. Скачайте данные по курсам валют с сайта ЦБ РФ
3. Сравните параметр продажи из CRM и из маркетинговых данных и удалите столбец с неполными данными.Таблица, в которой данных больше - полная!<br>
Столбец продажи должен остаться только в одной таблице!
4. В столбце Валюта в справочнике замените название валюты на то, как обозначена валюта в данных из ЦБ

В качестве домашней работы присылайте файл PBIX.

5. Дополнительное задание

![005](/GBPowerBI/Pictures/005_095.PNG)

[Содержание](#содержание)

[Содержание курса](/GBPowerBI/README.md)